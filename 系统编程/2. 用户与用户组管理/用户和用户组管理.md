# 用户和用户管理

用户是Linux系统中的一个重要概念，创建、删除和管理用户是Linux系统管理的基础。为方便对多用户的同时管理，Linux系统中又提出了用户组的概念，下面对用户和用户组进行讲解。

[TOC]

## 一、用户管理

用户管理即用户的账号管理，包括账号的添加、修改和删除。

相关命令：

- 用户账号添加——useradd
- 设置用户密码——passwd
- 删除用户账号——userdel
- 修改用户账号——usermod
---

### 1. 用户账号添加

用户账号添加即在系统中创建一个新账号，并为该账号设置用户号、用户组、主目录、登录Shell等。添加新账号时使用useradd命令，其命令格式如下：

```shell
useradd -option username
```

| 选项 |                         说明                         |
| :--: | :--------------------------------------------------: |
|  -d  |                 指定用户登录时的目录                 |
|  -c  |                 指定账户时的备注文字                 |
|  -e  |                  指定账号的有效期限                  |
|  -f  |      缓冲天数，密码过期时在指定天数后关闭该账号      |
|  -g  |                    指定用户所属组                    |
|  -G  |                 指定用户所属的附加组                 |
|  -m  |                   自动创建系统账号                   |
|  -r  |                     创建系统账号                     |
|  -s  |                 指定用户的登录Shell                  |
|  -u  | 指定用户的用户id（默认不可重复，应取$\ge 500 $的数） |
|  -o  |                 用-u指定id时可以重复                 |

利用 useradd 添加 itheima 用户时，使用 tail 观察 文件/etc/passwd。

<img src="https://github.com/terminator-128/FairLand.github.io/raw/master/pictures/UseraddCommandLine.jpg" style="zoom:80%;" /> 

可以看出在文件/etc/passwd中，一个账户信息生成一条记录（分隔为7项）。

```Linux
用户名:密码位:用户id(uid):用户组id(gid):注释信息(备注信息):用户主目录：Shell目录
```

新增的用户未指定uid，则其uid为前面一条记录的uid加1。并且此时新建的账号是无法使用的，因为尚未为该账号设置密码，账号处于锁定状态。

---



### 2. 设置用户密码

```shell
passwd -option username
```

| 选项 |                         说明                         |
| :--: | :--------------------------------------------------: |
|  -l  | 锁定密码，锁定后密码失效，无法登录（新用户默认锁定） |
|  -d  |         删除密码，仅系统管理员（root）可使用         |
|  -S  |      列出密码相关信息，仅系统管理员(root)可使用      |
|  -f  |                       强制执行                       |

<img src="https://github.com/terminator-128/FairLand.github.io/raw/master/pictures/passwdChange.jpg" style="zoom:80%;" />

修改后/etc/shadow中的密码信息也相应发生改变。

<img src="https://github.com/terminator-128/FairLand.github.io/raw/master/pictures/etcShadow.jpg" style="zoom:80%;" />

即相应的密码信息发生了改变，第二项由!!变为了加密后的代码。

---

### 3. 删除用户

若一个账号不再使用，可使用userdel命令，将该用户从系统中删除。

```shell
userdel -option username
```

| 选项 |                  说明                  |
| :--: | :------------------------------------: |
|  -f  |   强制删除用户，即便该用户为当前用户   |
|  -r  | 删除用户的同时删除与用户相关的所有文件 |

##### 案例：删除itheima及相关文件

<img src="https://github.com/terminator-128/FairLand.github.io/raw/master/pictures/userdelCommand.jpg" style="zoom:80%;" />

---

### 4. 修改用户账号

修改用户账号信息即修改账号的属性，如用户id，用户组，主目录，登录Shell等。

```shell
usermod -option username
```

| 选项 |                     说明                     |
| :--: | :------------------------------------------: |
|  -c  |              修改用户账号的备注              |
|  -d  |                 修改登录目录                 |
|  -e  |               修改账号有效期限               |
|  -f  | 修改缓冲天数，即修改密码过期后关闭账号的时间 |
|  -g  |                修改用户所属组                |
|  -l  |               修改用户账号名称               |
|  -L  |           锁定用户密码，使密码失效           |
|  -s  |          修改用户登录后使用的shell           |
|  -u  |                  修改用户id                  |
|  -U  |                使用户密码解锁                |

---



## 二、用户组管理

每个用户都有个用户组。如在创建账户时未指定，那么系统会以用户账号名作为该用户的用户组，并将与该账号同名的用户组同步到/etc/group文件中。

```Linux
#cat /etc/group | grep master
master:x:1000:
```

输出结果：组名 : 密码位 : gid:组内用户。

用户组相关命令：

- 添加用户组——groupadd
- 删除用户组——groupdel
- 修改组属性——groupmod
- 用户组切换——newgrp

---

### 1. 添加用户组

用户组可以在创建用户的同时默认设置，也可以有用户主动添加用户组。默认情况下新建用户的用户组与用户名相同，在创建用户的同时被创建。主动添加用户组时使用的命令为groupadd，命令格式：

```Linux
groupadd [-option] groupname
```

| 选项 |                说明                 |
| :--: | :---------------------------------: |
|  -g  |         指定新建用户组的id          |
|  -r  | 创建系统用户组，组id取值范围为1~499 |
|  -o  |     允许创建组id与存在的用户组      |

若选项缺省，则新增用户组其id值微商上一条<u>未指定</u>组id记录中组ID加1。

---

### 2. 删除组用户

若要删除已存在的用户组，使用groupdel命令。其命令格式如下。

```shell
groupdel groupname
```

---

### 3. 修改组属性

修改用户组的属性，如组id、组名。

```shell
groupmod -option groupname
```

| 选项 |         说明         |
| :--: | :------------------: |
|  -g  | 为用户组指定新的组id |
|  -n  |   修改用户组的组名   |
|  -o  |    允许组id不唯一    |

---

### 4. 用户组切换

在讲解用户切换方法之前，先来了解基本组和附加组的概念。

在useradd中提供了-g 和 -G两个选项，分别用于指定用户的所属组和附加组。

- 基本组：若用户被创建时没有指定用户组，则系统会为用户创建一个与用户名相同的组，这个组就是基本组；若在每个用户的目录创建文件，文件的所属组就是用户的基本组。
- 附加组：除了基本组织外用户所在组都是附加组。为用户指定附加组可使用户拥有对应组的权限。为用户指定附加组可以使用户拥有对应组的权限。用户可以从附加组中移除，但是不能从附加组中移除。

```shell
newgrp groupname
```

虽然newgrp使用条件是用户在这个组内，该命令不能改变用户/etc/passwd中的组id，但在创建文件时会改变所属组。

<img src="https://github.com/terminator-128/FairLand.github.io/raw/master/pictures/newgrp_command.jpg" style="zoom:80%;" />

##### newgrp的底层实现

其实，newgrp 命令每一次切换用户的初始组，该用户都会以另外一个 shell（新进程，也可以说是子进程）登陆，只不过在新 shell 上登陆的该用户，其初始组改变了而已。

```
通过添加 shell 内置命令 "echo $$" 就可以发现，每次使用 newgrp 命令，都会切换到一个新的进程。
```

使用 newgrp 命令切换用户初始组的整个过程，如图所示：

<img src="..\..\pictures\newgrp_base.gif" style="zoom:80%;" />

可以看到，每一次使用 newgrp 切换用户的初始组，用户都会切换到一个新的子 shell 中，如图 1 中，user1 用户的初始组从最初的 group1，切换成了 group2，再切换成 group3。

当然，如果你想回到原本的环境，需要通过 exit 命令不断回退到当前进程的父进程，最终才能回到初始组为 group1 时的 user1 运行的 shell 中。

<img src="https://github.com/terminator-128/FairLand.github.io/raw/master/pictures/newgrp_base2.jpg" style="zoom:80%;" />

可以注意到newgrp到原组并不能回到原进程:first_quarter_moon_with_face: 。

---



## 用户切换

Linux系统中可以直接使用命令进行用户切换，下面对用户切换命令进行讲解。

### 1. su

使用su命令切换用户是最简单的用户切换方式，该命令可以在任意用户间进行切换。

<img src="https://github.com/terminator-128/FairLand.github.io/raw/master/pictures/su_use.png" style="zoom:80%;" />

[^]: 需要注意的是，su命令中，- 为一个选项，类似 -l。选项与用户名见有一个空格。

- 由普通用户切换到目标用户时，需要输入目标用户的密码。

  - 由普通用户切换到非root用户，使用`su username`

  - 由普通用户切换到root用户，且不切换环境变量，使用 `su`.
  - 由普通用户切换到root用户，且切换到root的环境变量，使用 `su - `.

- 由root用户切换到其他用户，可以不输入密码。

---

### sudo

 虽然su命令使用起来很方便，但使用其他用户时候需要知道其他用户的密码。如果需要root权限的用户都知道root密码，系统的安全性没有了保障，su是不安全的。如何不使用su命令提升权限？

Linux提供了另外一个切换用户的命令。——sudo。

```shell
sudo -option -u user [order]
```

<img src="https://github.com/terminator-128/FairLand.github.io/raw/master/pictures/sudo_use.png" style="zoom:80%;" />

[^]: sudo 可视为受限的su，它能使“部分用户”使用其他用户的身份执行命令。若要使用root权限，只需使用root用户的身份即可。而若允许用户使用这个方法改变身份，需要将用户添加到/etc/sudoers。存在于/etc/sudoers中的用户使用其他身份只需输入自己的密码（5分钟有效，5分钟之后再输入）。

#### 使用root编辑/etc/sudoers

使用 `visudo`命令编辑sudoers文件。

<img src="https://github.com/terminator-128/FairLand.github.io/raw/master/pictures/sudoers_syntax.jpg" style="zoom:80%;" />

权限设置语句格式：

```Linux
账户名 主机名称=（可切换的身份） 可执行的命令
```

以上格式包含4个参数：

- 账户名。改参数表示要设置权限的账号名，只有写入sudoers文件的用户才可使用sudo命令。root默认可以使用sudo命令。账户名可以为用户名或组名。
- 主机名称。该参数决定此条语句中账户名对应的用户可以从哪些网络主机连接当前Linux主句。root用户默认可以来自任何一台网络主机。
- 可切换的身份。该参数决定此条语句中的用户可以执行哪些命令。root默认可切换为任何用户。
- 可执行的命令。
  - 该参数指定此条语句中的用户可以执行哪些命令。注意命令的路径应为绝对路径。root用户默认可使用任何命令。
  - 可通过在命令路径前添加!禁止命令执行。

